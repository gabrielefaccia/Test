<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbratura Mobile</title>
</head>
<body>
  <h2>Login Timbratura</h2>
  <input type="text" id="username" placeholder="Nome utente" />
  <input type="password" id="accessKey" placeholder="Access Key" />
  <button onclick="accedi()">Accedi</button>
  <p id="loginMsg" style="color:red;"></p>

  <div id="timbraturaBox" style="display:none;">
    <h3>Timbratura</h3>
    <select id="tipo">
      <option value="Entrata">Entrata</option>
      <option value="Uscita">Uscita</option>
    </select>
    <button onclick="timbra()">Timbra Ora</button>
    <p id="timbraMsg"></p>
  </div>

  <script>
    let basicToken = '';
    let assignedUserId = '';
    let username = '';

    function accedi() {
      username = document.getElementById('username').value;
      const accessKey = document.getElementById('accessKey').value;
      basicToken = btoa(username + ':' + accessKey);

      fetch('https://crm.fefcentroautomazioni.it/restapi/v1/vtews/query', {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + basicToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: `SELECT id FROM Users WHERE user_name='${username}'` })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 200 && data.data && data.data.length > 0) {
          assignedUserId = data.data[0].id;
          document.getElementById('loginMsg').innerText = 'Login riuscito. ID utente: ' + assignedUserId;
          document.getElementById('timbraturaBox').style.display = 'block';
        } else {
          document.getElementById('loginMsg').innerText = 'Credenziali non valide.';
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('loginMsg').innerText = 'Errore di rete o server.';
      });
    }

    function timbra() {
      const tipo = document.getElementById('tipo').value;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          .then(res => res.json())
          .then(data => {
            const indirizzo = data.display_name || 'Indirizzo non trovato';
            const now = new Date();
            const dataStr = now.toISOString().split('T')[0];
            const oraSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            const payload = {
              elementType: 'Timbrature',
              element: {
                vcf_1_1: 'timbratura mobile',
                vcf_1_2: tipo,
                vcf_1_3: lat.toString(),
                vcf_1_4: lon.toString(),
                vcf_1_5: indirizzo,
                vcf_1_6: dataStr,
                vcf_1_7: oraSec.toString(),
                assigned_user_id: assignedUserId,
                description: 'Timbratura via mobile da ' + username
              }
            };

            fetch('https://crm.fefcentroautomazioni.it/restapi/v1/vtews/create', {
              method: 'POST',
              headers: {
                'Authorization': 'Basic ' + basicToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
              if (response.status === 200) {
                document.getElementById('timbraMsg').innerText = 'Timbratura registrata correttamente';
              } else {
                document.getElementById('timbraMsg').innerText = 'Errore durante la timbratura';
              }
            });
          });
      }, () => {
        alert('Geolocalizzazione non disponibile o negata.');
      });
    }
  </script>
</body>
</html>
