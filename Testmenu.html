<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timbratura Mobile</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#006400"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .clock {
      font-size: 24px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }
    #msgBanner {
      display: none;
      padding: 12px;
      font-weight: bold;
      white-space: pre-line;
    }
    .error {
      color: red;
    }
    img.logo {
      max-width: 100%;
      height: auto;
      max-height: 80px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="data:image/jpeg;base64,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Euo6hqUfjTwjoLL4wRSMrAlSpweeuT065rlooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAJS1XVLR9Omvr+cCQxLkn19hVdRwVbnh/wAI9rBJH9nXOe/7s11QAUUUUAFFFFABRRRQBVTjTR9PuL+7GWQrB6MOQP6iq5+K/8FF2rTfFehaTZrfX93fLZ6/h5Xdxt3KOg6n5inmiiiAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigArM05rqE3Sr/hR+ycXU0kguzJJ2yYk/PjB/M0Ny0/UdQuoA39pX7P8AdQWMwFjzbj+9Gc/wCa2/nX/0KhFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAFUtV1S10fTpr6/igJCQuSfX2FXb8O+K/id9Q1YaPbif6Na/63H8Un/1q2oUnUnymGIrKlDmOY8WeKrvxRqZXExKwISJYasQZFUd9wduKsueBRaq2RS2jLCvQEjJVQ5GeD15z+tNFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQBVO1aNBNtU0sJH5VlkBPmIye7Lcj8a5KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKSkuu7Sa4RjUJmq4HImLcYOTx6kY+3akKACiiigAooooAKKKKACiiigAooooAKKKKAI5CieZUdkZyOvXgfl/nSk1Vc6poZpi11IYrlSwynPG+xpVzRXwv8AhR4T+IaNcX1rDdyTbeT7zmRf9wuPUn9K+q+I/BL4nGGg3P8AZUMtqy/SX+zGfN5bcey/wCrmmigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAqen8SXkTfPhnDS21Mt80Nt3oAORgHivJQB3drcaZqLuFeS+zFlClpHy+XG4/Gsp5rnyC9Pnilu2kwp2iXDMTOCQ8nGP8AaFWiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKTpeuy2aJJbaLqEiQiRnGQQfU8deaKKKACiiigAooooAKKKKACiiigAqGqWms9N0LSJHbTyBUjKT2B3Z5znHI6k0pRRRQBWsXlhn+ztF8zTtVn6dp3/wDHqKKACiiigAooooAKKKKACiokSMZSpIyefYd+9IA3Fab/wAFsfBjTO+EviZb/ALPBur6f8RA8bwA/Ws3k3wG8e6dl4NK08KzWbZmh/3HYH+9sH0AqKKKACiiigAooooAKKKKACiiigAooooAK9vEeu6fbR03xo1hsdLJD+6X27gNByff2qP2iPhz40y+EHgPwpZ3FpbbXU1sby0wzYsWYtnArH09Mcc1xVFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAGP2hviT8R/Cuh3Op6vb6G2tzXZ2pl/ROLSQspJ3Kce2c1rxn47eHfAk320cM3EchRbcRBK7bgY4xxXL+g/DLwp4hpWkGpXmmAoYpUACrlWB7ZHWs1FFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAD/9k=" alt="Logo" class="logo" />
    <div id="msgBanner"></div>
    <div id="loginBox">
      <h2>Accesso Timbratura</h2>
      <input type="text" id="username" placeholder="Nome utente">
      <input type="password" id="accessKey" placeholder="Access Key">
      <button onclick="accedi()">Accedi</button>
      <p id="loginMsg" class="error"></p>
    </div>

    <div id="timbraturaBox" style="display:none;">
      <h2>Timbratura Mobile</h2>
      <div class="clock" id="clock">--:--:--</div>
      <select id="tipo">
        <option value="Entrata">Entrata</option>
        <option value="Uscita">Uscita</option>
      </select>
      <button onclick="timbra()">Timbra Ora</button>
      <div class="info" id="infoBox"></div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(function() { console.log('Service Worker registrato'); });
  }

    function formatSecondsToTime(secStr) {
      const sec = parseInt(secStr);
      const hrs = String(Math.floor(sec / 3600)).padStart(2, '0');
      const mins = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const secs = String(sec % 60).padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    let basicToken = "";
    let currentUsername = "";

    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById("clock").textContent = timeString;
    }
    setInterval(updateClock, 1000);

    function accedi() {
      const username = document.getElementById("username").value;
      const accessKey = document.getElementById("accessKey").value;
      currentUsername = username;
      basicToken = btoa(username + ":" + accessKey);

      fetch("https://crm.fefcentroautomazioni.it/restapi/v1/vtews/create", {
        method: "OPTIONS",
        headers: {
          "Authorization": "Basic " + basicToken
        }
      }).then(res => {
        if (res.status === 200 || res.status === 401) {
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("timbraturaBox").style.display = "block";
        } else {
          document.getElementById("loginMsg").innerText = "Accesso negato.";
        }
      }).catch(err => {
        document.getElementById("loginMsg").innerText = "Errore di rete.";
      });
    }

    function timbra() {
      const tipo = document.getElementById("tipo").value;

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
          const indirizzo = data.display_name || "Indirizzo non trovato";
          const now = new Date();
          const dataStr = now.toISOString().split("T")[0];
          const ora = now.toTimeString().split(" ")[0];

          const payload = {
            elementType: "Timbrature",
            element: {
              vcf_1_1: "timbratura mobile",
              vcf_1_2: tipo,
              vcf_1_3: lat.toString(),
              vcf_1_4: lon.toString(),
              vcf_1_5: indirizzo,
              vcf_1_6: dataStr,
              vcf_1_7: ora,
              assigned_user_id: currentUsername,
              description: "Timbratura via mobile da " + currentUsername
            }
          };

          fetch("https://crm.fefcentroautomazioni.it/restapi/v1/vtews/create", {
            method: "POST",
            headers: {
              "Authorization": "Basic " + basicToken,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
            const banner = document.getElementById("msgBanner");
            banner.style.display = "block";
            if (data.status === 200 && data.data && data.data.id) {
              banner.className = "";
              banner.style.backgroundColor = "#d4edda";
              banner.style.color = "#155724";
              banner.innerText = `Timbratura di ${tipo.toLowerCase()} registrata alle ${formatSecondsToTime(data.data.vcf_1_7)} del ${data.data.vcf_1_6} all’indirizzo:\n${data.data.vcf_1_5}`;
              document.querySelector("button[onclick='timbra()']").style.display = "none";
              document.getElementById("tipo").style.display = "none";
            } else {
              banner.className = "";
              banner.style.backgroundColor = "#f8d7da";
              banner.style.color = "#721c24";
              banner.innerText = "Errore: timbratura non registrata. (Riprovare quando avrai più connessione)";
            }
          });
        });
      }, () => {
        alert("Geolocalizzazione negata. Vai in Impostazioni > Browser > Posizione e attivala per questo sito.");
      });
    }

    function logout() {
      basicToken = "";
      currentUsername = "";
      document.getElementById("timbraturaBox").style.display = "none";
      document.getElementById("loginBox").style.display = "block";
      document.getElementById("msgBanner").style.display = "none";
      document.getElementById("tipo").style.display = "inline-block";
      document.querySelector("button[onclick='timbra()']").style.display = "inline-block";
    }
  </script>
</body>
</html>
