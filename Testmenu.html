<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbratura Mobile</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#006400" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .clock {
      font-size: 24px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }
    #msgBanner {
      display: none;
      padding: 12px;
      font-weight: bold;
      white-space: pre-line;
    }
    .error {
      color: red;
    }
    img.logo {
      max-width: 100%;
      height: auto;
      max-height: 80px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 14px;
      text-align: center;
    }
    th {
      background: #333;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="data:image/jpeg;base64,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" alt="Logo" class="logo" />
    <div id="msgBanner"></div>
    <div id="menu" style="display:none; text-align:right;">
      <a href="#" onclick="showStorico()">Storico timbrature</a> | 
      <a href="#" onclick="logout()">Logout</a>
    </div>
    <div id="loginBox">
      <h2>Accesso Timbratura</h2>
      <input type="text" id="username" placeholder="Nome utente" />
      <input type="password" id="accessKey" placeholder="Access Key" />
      <button onclick="accedi()">Accedi</button>
      <p id="loginMsg" class="error"></p>
    </div>
    <div id="timbraturaBox" style="display:none;">
      <h2>Timbratura Mobile</h2>
      <div class="clock" id="clock">--:--:--</div>
      <select id="tipo">
        <option value="Entrata">Entrata</option>
        <option value="Uscita">Uscita</option>
      </select>
      <button onclick="timbra()">Timbra Ora</button>
    </div>
    <div id="storicoBox" style="display:none; text-align:left;">
      <h2>Storico Timbrature</h2>
      <div>
        <label>Da: <input type="date" id="fromDate" /></label>
        <label style="margin-left:10px;">A: <input type="date" id="toDate" /></label>
        <button onclick="caricaStorico()">Carica</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Entrata</th>
            <th>Uscita Pranzo</th>
            <th>Rientro</th>
            <th>Uscita</th>
            <th>Ore lavorate</th>
            <th>Straordinari</th>
          </tr>
        </thead>
        <tbody id="storicoBody">
          <tr><td colspan="7">Nessun dato</td></tr>
        </tbody>
      </table>
      <button onclick="closeStorico()">Torna alla timbratura</button>
    </div>
  </div>
  <script>
    // Registrazione opzionale di un Service Worker (per PWA/offline, se file service-worker.js presente)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(function() { console.log('Service Worker registrato'); });
    }
    // Utilità: formatta secondi (dal giorno) in stringa HH:MM:SS
    function formatSecondsToTime(secStr) {
      const sec = parseInt(secStr);
      const hrs = String(Math.floor(sec / 3600)).padStart(2, '0');
      const mins = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const secs = String(sec % 60).padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }
    // Utilità: formatta data ISO (YYYY-MM-DD) in formato italiano DD/MM/YYYY
    function formatDateISOToIT(dateStr) {
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return parts[2] + '/' + parts[1] + '/' + parts[0];
      }
      return dateStr;
    }
    let basicToken = '';
    let currentUsername = '';
    let assignedUserId = '';
    // Controllo sessione persistente
    if (localStorage.getItem('token')) {
      basicToken = localStorage.getItem('token');
      currentUsername = localStorage.getItem('username') || '';
      assignedUserId = localStorage.getItem('userid') || '';
      if (basicToken) {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('timbraturaBox').style.display = 'block';
        document.getElementById('menu').style.display = 'block';
      }
    }
    // Orologio in tempo reale
    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('clock').textContent = timeString;
    }
    setInterval(updateClock, 1000);
    // Funzione di login
    function accedi() {
      const username = document.getElementById('username').value;
      const accessKey = document.getElementById('accessKey').value;
      currentUsername = username;
      basicToken = btoa(username + ':' + accessKey);
      // Verifica credenziali via API (chiamata query per ottenere user id)
      fetch('https://crm.fefcentroautomazioni.it/restapi/v1/vtews/query', {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + basicToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: `SELECT id FROM Users WHERE user_name='${username}'` })
      })
      .then(res => {
        if (res.status === 401) {
          document.getElementById('loginMsg').innerText = 'Accesso negato.';
          throw new Error('Unauthorized');
        }
        return res.json();
      })
      .then(data => {
        if (data && data.status === 200 && data.data && data.data.length > 0) {
          assignedUserId = data.data[0].id;
        } else {
          assignedUserId = '';
        }
        // Salva credenziali in localStorage per persistenza sessione
        localStorage.setItem('token', basicToken);
        localStorage.setItem('username', username);
        localStorage.setItem('userid', assignedUserId);
        // Mostra interfaccia principale
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('timbraturaBox').style.display = 'block';
        document.getElementById('menu').style.display = 'block';
        document.getElementById('loginMsg').innerText = '';
      })
      .catch(err => {
        if (err.message !== 'Unauthorized') {
          document.getElementById('loginMsg').innerText = 'Errore di rete.';
        }
      });
    }
    // Funzione di timbratura
    function timbra() {
      const tipo = document.getElementById('tipo').value;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        // Reverse geocoding OSM
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          .then(res => res.json())
          .then(data => {
            const indirizzo = data.display_name || 'Indirizzo non trovato';
            const now = new Date();
            const dataStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            // Calcola secondi dall'inizio del giorno per l'ora corrente
            const oraSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const payload = {
              elementType: 'Timbrature',
              element: {
                vcf_1_1: 'timbratura mobile',
                vcf_1_2: tipo,
                vcf_1_3: lat.toString(),
                vcf_1_4: lon.toString(),
                vcf_1_5: indirizzo,
                vcf_1_6: dataStr,
                vcf_1_7: oraSec.toString(),
                assigned_user_id: assignedUserId,
                description: 'Timbratura via mobile da ' + currentUsername
              }
            };
            fetch('https://crm.fefcentroautomazioni.it/restapi/v1/vtews/create', {
              method: 'POST',
              headers: {
                'Authorization': 'Basic ' + basicToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
              const banner = document.getElementById('msgBanner');
              banner.style.display = 'block';
              if (data.status === 200 && data.data && data.data.id) {
                // Successo: messaggio verde
                banner.className = '';
                banner.style.backgroundColor = '#d4edda';
                banner.style.color = '#155724';
                banner.innerText = `Timbratura di ${tipo.toLowerCase()} registrata alle ${formatSecondsToTime(data.data.vcf_1_7)} del ${data.data.vcf_1_6} all’indirizzo:\n${data.data.vcf_1_5}`;
              } else {
                // Errore: messaggio rosso
                banner.className = '';
                banner.style.backgroundColor = '#f8d7da';
                banner.style.color = '#721c24';
                banner.innerText = 'Errore: timbratura non registrata. (Riprovare quando avrai più connessione)';
              }
            });
          });
      }, () => {
        alert('Geolocalizzazione negata. Vai in Impostazioni > Browser > Posizione e attivala per questo sito.');
      });
    }
    // Mostra la sezione storico
    function showStorico() {
      document.getElementById('timbraturaBox').style.display = 'none';
      document.getElementById('storicoBox').style.display = 'block';
      // Imposta intervallo date di default (anno corrente)
      const today = new Date();
      const yyyy = today.getFullYear();
      document.getElementById('fromDate').value = `${yyyy}-01-01`;
      document.getElementById('toDate').value = today.toISOString().split('T')[0];
      // Nasconde eventuali messaggi banner
      document.getElementById('msgBanner').style.display = 'none';
      // Carica subito lo storico di default
      caricaStorico();
    }
    // Torna alla schermata timbratura
    function closeStorico() {
      document.getElementById('storicoBox').style.display = 'none';
      document.getElementById('timbraturaBox').style.display = 'block';
      document.getElementById('msgBanner').style.display = 'none';
    }
    // Carica lo storico timbrature per l'intervallo selezionato
    function caricaStorico() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (!from || !to) {
        alert('Seleziona le date "Da" e "A".');
        return;
      }
      if (from > to) {
        alert('Intervallo di date non valido.');
        return;
      }
      const query = `SELECT vcf_1_6, vcf_1_7, vcf_1_2 FROM Timbrature WHERE assigned_user_id='${assignedUserId}' AND vcf_1_6 >= '${from}' AND vcf_1_6 <= '${to}' ORDER BY vcf_1_6 ASC, vcf_1_7 ASC`;
      fetch('https://crm.fefcentroautomazioni.it/restapi/v1/vtews/query', {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + basicToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: query })
      })
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('storicoBody');
        tbody.innerHTML = '';
        if (data.status === 200 && data.data) {
          const records = data.data;
          if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">Nessun dato</td></tr>';
            return;
          }
          let currentDate = '';
          let dayRecords = [];
          for (const rec of records) {
            if (rec.vcf_1_6 !== currentDate) {
              // Processa il gruppo precedente prima di passare a nuova data
              if (dayRecords.length > 0) {
                const day = currentDate;
                // Inizializza orari come stringhe vuote
                let e1='', u1='', e2='', u2='';
                dayRecords.forEach(r => {
                  const tipo = r.vcf_1_2;
                  const timeVal = r.vcf_1_7;
                  // Converte il valore orario (stringa "HH:MM:SS" o secondi) in formato HH:MM:SS
                  let seconds;
                  if (typeof timeVal === 'string' && timeVal.indexOf(':') !== -1) {
                    const parts = timeVal.split(':');
                    seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
                  } else {
                    seconds = parseInt(timeVal);
                  }
                  const timeStr = formatSecondsToTime(seconds);
                  if (tipo.toLowerCase() === 'entrata') {
                    if (!e1) e1 = timeStr;
                    else if (!e2) e2 = timeStr;
                  } else if (tipo.toLowerCase() === 'uscita') {
                    if (!u1) u1 = timeStr;
                    else if (!u2) u2 = timeStr;
                  }
                });
                // Calcola ore lavorate e straordinari per la data
                let totalSec = 0;
                const secE1 = e1 ? hmsToSec(e1) : 0;
                const secU1 = u1 ? hmsToSec(u1) : 0;
                const secE2 = e2 ? hmsToSec(e2) : 0;
                const secU2 = u2 ? hmsToSec(u2) : 0;
                if (e1 && u1) {
                  totalSec += (secU1 - secE1);
                }
                if (e2 && u2) {
                  totalSec += (secU2 - secE2);
                }
                if (totalSec < 0) totalSec = 0;
                const workHours = secondsToHHMM(totalSec);
                let overtimeSec = totalSec - 28800; // 8 ore = 28800 sec
                let overtimeStr = secondsToHHMM(Math.abs(overtimeSec));
                if (overtimeSec < 0) {
                  overtimeStr = '-' + overtimeStr;
                }
                const dateCell = formatDateISOToIT(day);
                tbody.innerHTML += `<tr><td>${dateCell}</td><td>${e1 || ''}</td><td>${u1 || ''}</td><td>${e2 || ''}</td><td>${u2 || ''}</td><td>${workHours}</td><td>${overtimeStr}</td></tr>`;
              }
              // Nuova data: reset array e aggiorna currentDate
              currentDate = rec.vcf_1_6;
              dayRecords = [];
            }
            dayRecords.push(rec);
          }
          // Processa l'ultimo gruppo di dayRecords rimasto
          if (dayRecords.length > 0) {
            const day = currentDate;
            let e1='', u1='', e2='', u2='';
            dayRecords.forEach(r => {
              const tipo = r.vcf_1_2;
              const timeVal = r.vcf_1_7;
              let seconds;
              if (typeof timeVal === 'string' && timeVal.indexOf(':') !== -1) {
                const parts = timeVal.split(':');
                seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
              } else {
                seconds = parseInt(timeVal);
              }
              const timeStr = formatSecondsToTime(seconds);
              if (tipo.toLowerCase() === 'entrata') {
                if (!e1) e1 = timeStr;
                else if (!e2) e2 = timeStr;
              } else if (tipo.toLowerCase() === 'uscita') {
                if (!u1) u1 = timeStr;
                else if (!u2) u2 = timeStr;
              }
            });
            let totalSec = 0;
            const secE1 = e1 ? hmsToSec(e1) : 0;
            const secU1 = u1 ? hmsToSec(u1) : 0;
            const secE2 = e2 ? hmsToSec(e2) : 0;
            const secU2 = u2 ? hmsToSec(u2) : 0;
            if (e1 && u1) {
              totalSec += (secU1 - secE1);
            }
            if (e2 && u2) {
              totalSec += (secU2 - secE2);
            }
            if (totalSec < 0) totalSec = 0;
            const workHours = secondsToHHMM(totalSec);
            let overtimeSec = totalSec - 28800;
            let overtimeStr = secondsToHHMM(Math.abs(overtimeSec));
            if (overtimeSec < 0) {
              overtimeStr = '-' + overtimeStr;
            }
            const dateCell = formatDateISOToIT(day);
            tbody.innerHTML += `<tr><td>${dateCell}</td><td>${e1 || ''}</td><td>${u1 || ''}</td><td>${e2 || ''}</td><td>${u2 || ''}</td><td>${workHours}</td><td>${overtimeStr}</td></tr>`;
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="error">Errore nel recupero dello storico.</td></tr>';
        }
      })
      .catch(error => {
        const tbody = document.getElementById('storicoBody');
        tbody.innerHTML = '<tr><td colspan="7" class="error">Errore nel recupero dello storico.</td></tr>';
      });
    }
    // Funzione di supporto: converti "HH:MM:SS" in secondi (numero)
    function hmsToSec(hms) {
      if (!hms) return 0;
      const parts = hms.split(':');
      if (parts.length === 3) {
        return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
      }
      return parseInt(hms) || 0;
    }
    // Funzione di supporto: converti secondi in formato "HH:MM" (ore e minuti)
    function secondsToHHMM(sec) {
      const hrs = Math.floor(sec / 3600);
      const mins = Math.floor((sec % 3600) / 60);
      return String(hrs).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
    }
    // Logout: reset credenziali e UI
    function logout() {
      basicToken = '';
      currentUsername = '';
      assignedUserId = '';
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('userid');
      document.getElementById('timbraturaBox').style.display = 'none';
      document.getElementById('storicoBox').style.display = 'none';
      document.getElementById('menu').style.display = 'none';
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('msgBanner').style.display = 'none';
      document.getElementById('loginMsg').innerText = '';
    }
  </script>
</body>
</html>

Questo lo hai creato tu
Inseriscimelo in un file 
